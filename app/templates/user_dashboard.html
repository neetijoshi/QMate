<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>QMate User Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* :root{
  --accent:#ecd386;
  --brand:#4d69a5;
  --focus:#5ba8a6;
  --bg:#eae6dd;
  --text:#323232;
} */
:root{
  --primary:#4d69a5;
  --accent:#ecd386;
  --bg:#f4f6fb;
  --dark:#2c2c2c;
}

body{
  margin:0;
  font-family:'Segoe UI', sans-serif;
  background:#f4f6fb;   /* SAME AS LANDING PAGE */
  color:#2c2c2c;
}


/* NAVBAR */
.navbar{
  background:#fff;
  padding:15px 40px;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #ddd;
  align-items:center;
}
.navbar h2{
  margin:0; color:var(--brand); font-weight:600;
}
.user-type{
  display:flex; gap:10px;
}
.user-type button{
  border:1px solid var(--brand);
  padding:6px 14px;
  border-radius:20px;
  background:#fff;
  cursor:pointer;
  transition:0.2s;
}
.user-type button:hover{
  background:#f3f3f3;
}
.user-type button.active{
  background:var(--brand);
  color:white;
}

/* LAYOUT */
.container{
  padding:30px;
  gap:30px;
}
.content{
  margin-left:25px;
}


/* SIDEBAR */
.sidebar{
  width:260px;
  background:white;
  border-radius:20px;
  padding:20px;
  box-shadow:0 8px 25px rgba(0,0,0,0.08);
}

.sidebar button{
  width:100%;
  background:none;
  border:none;
  cursor:pointer;
  text-align:left;
  padding:12px 10px;
  border-radius:8px;
  font-size:15px;
  display:flex;
  align-items:center;
  gap:12px;
  color:var(--text);
  transition:0.2s;
}
.sidebar button:hover{
  background:#f3f3f3;
}
.sidebar button.active{
  background:var(--primary);
  color:white;
}


/* LOGOUT BUTTON (permanent accent color) */
.sidebar button.logout-btn{
  background:var(--accent);
  color:var(--text);
  font-weight:600;
  margin-top:20px;
  justify-content:center;
  text-align:center;
}
.sidebar button.logout-btn:hover{
  filter:brightness(0.95);
}

/* CONTENT AREA */
.content{
  flex:1;
}

.page{
  background:white;
  padding:30px;
  border-radius:20px;
  box-shadow:0 8px 25px rgba(0,0,0,0.08);
  display:none;
}

.page.active{
  display:block;
}

h3{ color:var(--brand); margin-top:0; }

/* MAIN BUTTONS */
/* .main-btn{
  padding:12px 20px;
  width:100%;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background-color: var(--accent);
  color:var(--text);
  font-weight:600;
  transition:0.2s;
} */
 .main-btn{
  border-radius:25px;
  padding:14px 24px;
  font-size:15px;
  background:var(--accent);
  box-shadow:0 6px 16px rgba(0,0,0,0.15);
}

.main-btn:hover{
  filter:brightness(0.95);
}

/* disabled style */
.main-btn[disabled]{
  cursor:not-allowed;
  opacity:0.75;
}
.small-note{
  margin-top:10px;
  font-size:14px;
  color:#666;
}
.small-note a{ color:var(--brand); text-decoration:none; font-weight:600; }

/* ACCOUNT TABS */
.account-tab {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 8px;
  border: none;
  background: #f3f3f3;
  border-radius: 6px;
  cursor: pointer;
  text-align: left;
  font-weight: 500;
}

.account-tab.active {
  background: var(--brand);
  color: white;
}

/* ACCOUNT SECTIONS */
.account-section {
  display: none;
}

.account-section.active {
  display: block;
}

/* SMALL BUTTON (fix oversized button issue) */
.small-btn {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  background: var(--accent);
  font-weight: 600;
  cursor: pointer;
  width: auto;        /* üî• THIS fixes vertical stretch */
}
.history-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 15px;
}

.history-card {
  padding: 14px 18px;
  background: #f8f8f8;
  border-left: 6px solid var(--brand);
  border-radius: 8px;
  font-size: 14px;
}
input[type="password"] {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 6px;
  font-size: 14px;
}

input[type="password"]:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 2px rgba(77,105,165,0.2);
}
.page{
  animation:fadeUp 0.4s ease;
}

@keyframes fadeUp{
  from{opacity:0; transform:translateY(20px);}
  to{opacity:1; transform:translateY(0);}
}

</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <h2 style="color: var(--primary); margin: 0;">QMate</h2>

  <div style="display:flex; align-items:center; gap:15px;">
    <div class="user-type">
      <button class="active">User</button>
      <button onclick="window.location.href='/'">Admin</button>
    </div>

    <!-- PROFILE ICON -->
    <div onclick="openAccount()" style="
      cursor:pointer;
      background:#4d69a5;
      color:white;
      width:36px;
      height:36px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
    ">
      <i class="fa-solid fa-user"></i>
    </div>
    <div onclick="goHome()" style="
  cursor:pointer;
  background:#f3f3f3;
  color:#4d69a5;
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
">
  <i class="fa-solid fa-house"></i>
</div>

  </div>
</div>


<!-- MAIN LAYOUT -->
<div class="container">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <button class="active" onclick="switchPage('getToken', this)"><i class="fa-solid fa-ticket"></i> Get Token</button>
    <button onclick="switchPage('queueStatusPage', this)"><i class="fa-solid fa-bars-progress"></i> Queue Status</button>
    <button onclick="switchPage('notifications', this)"><i class="fa-solid fa-bell"></i> Notifications</button>
    <button class="logout-btn" onclick="logoutUser()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
  </div>
<!-- CONTENT AREA -->
<div class="content">
  <div style="
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:30px;
">
  <div class="page">
    <h4>Total Tokens</h4>
    <h2 style="color:var(--primary);">12</h2>
  </div>

  <div class="page">
    <h4>Current Queue</h4>
    <h2 style="color:var(--primary);">Billing</h2>
  </div>

  <div class="page">
    <h4>Estimated Wait</h4>
    <h2 style="color:var(--primary);">15 min</h2>
  </div>
</div>

  <!-- Get Token Page -->
  <div class="page active" id="getToken">
    <h3>Get Queue Token</h3>
    <p>Select a service queue to join and get your token number.</p>

    <label>Available Queues</label><br><br>
    <select id="queueSelect" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:6px;">
      <option value="">Select a queue to join</option>
      <option>Billing</option>
      <option>General Helpdesk</option>
      <option>Document Verification</option>
    </select><br><br>

    {% if guest %}
      <button class="main-btn" disabled>Login to get tokens.</button>
      <div class="small-note">
        Please <a href="{{ url_for('main.index') }}">login or register</a> to get a token.
      </div>
    {% else %}
      <button id="getTokenBtn" class="main-btn" onclick="requestToken()">Get My Token</button>
    {% endif %}
  </div>

  <!-- Queue Status Page -->
  <div class="page" id="queueStatusPage">
    <h3>Current Queue Status</h3>
    <p id="queuePlaceholder" style="color:#666;">
      Your queue status will appear here. Please get your token.
    </p>
    <p id="queueInfo"></p>
    <div style="margin-top:20px;">
  <div style="background:#eee; border-radius:10px; height:12px;">
    <div style="
      width:45%;
      background:var(--primary);
      height:100%;
      border-radius:10px;
    "></div>
  </div>
  <small>45% completed</small>
</div>

  </div>

  <!-- Notifications Page -->
  <div class="page" id="notifications">
    <h3>Notifications</h3>
    <p>Your updates and alerts will appear here.</p>
  </div>

  <!-- ‚úÖ ACCOUNT PAGE (NOW REALLY INSIDE CONTENT) -->
  <div class="page" id="accountPage" style="max-width:900px; margin:40px auto;">
    <h3>My Account</h3>

    <div style="display:flex; gap:30px; margin-top:20px;">

      <!-- ACCOUNT SIDE MENU -->
      <div style="width:220px;">
        <button class="account-tab active" onclick="showAccountSection('basic')">
          Basic Info
        </button>
        <button class="account-tab" onclick="showAccountSection('history')">
          Token History
        </button>
        <button class="account-tab" onclick="showAccountSection('password')">
          Change Password
        </button>
      </div>

      <!-- ACCOUNT CONTENT -->
      <div style="flex:1;">

        <!-- BASIC INFO -->
        <div id="basicSection" class="account-section active">
          <p><b>Name:</b> <span id="accName"></span></p>
          <p><b>Email:</b> <span id="accEmail"></span></p>
          <p><b>Total Tokens Taken:</b> <span id="accTokenCount"></span></p>
        </div>

        <!-- TOKEN HISTORY -->
        <div id="historySection" class="account-section">
          <h4>Token History</h4>
          <div id="tokenHistory" class="history-list"></div>
        </div>

        <!-- CHANGE PASSWORD -->
        <div id="passwordSection" class="account-section">
          <label>Current Password</label><br>
          <input type="password" id="currentPwd"><br><br>

          <label>New Password</label><br>
          <input type="password" id="newPwd"><br><br>

          <button class="small-btn" onclick="changePassword()">
            Update Password
          </button>
        </div>

      </div>
    </div>
  </div>

</div> <!-- ‚úÖ ONLY ONE closing for .content -->


<!-- SAME UI AS YOURS ABOVE -->
<!-- ONLY JS CHANGED -->
<script>
function switchPage(pageId, btn) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(pageId).classList.add("active");

  document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}
</script>

<script>
function showToast(msg, error=false){
  const toast = document.createElement("div");
  toast.innerText = msg;
  toast.style.position = "fixed";
  toast.style.bottom = "30px";
  toast.style.right = "30px";
  toast.style.background = error ? "#c0392b" : "#4d69a5";
  toast.style.color = "white";
  toast.style.padding = "14px 20px";
  toast.style.borderRadius = "8px";
  toast.style.fontWeight = "500";
  document.body.appendChild(toast);

  setTimeout(()=> toast.remove(), 3000);
}

function requestToken(){
  const queue = document.getElementById("queueSelect").value;
  if(!queue){
    showToast("Select a queue first", true);
    return;
  }

  fetch("/request_token", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({queue})
  })
  .then(res => res.json())
  .then(data => {
    if(data.error){
      showToast(data.error, true);
    } else {
      showToast("Your token number is " + data.token);
    }
  })
  .catch(() => showToast("Server error", true));
}
</script>
<div id="notification" style="
  display:none;
  position:fixed;
  top:20px;
  right:20px;
  background:#4d69a5;
  color:white;
  padding:15px 20px;
  border-radius:8px;
  font-weight:500;
  z-index:9999;
">
</div>
<script>
let lastStatus = null;

function checkTokenStatus() {
  fetch("/user/token_status")
    .then(res => res.json())
    .then(data => {

      const placeholder = document.getElementById("queuePlaceholder");
      const info = document.getElementById("queueInfo");

      // ‚ùå No token ‚Üí show placeholder
      if (!data.has_token) {
        placeholder.style.display = "block";
        info.innerHTML = "";
        return;
      }

      // ‚úÖ Token exists ‚Üí hide placeholder
      placeholder.style.display = "none";

if (data.status === "YOUR_TURN") {
  document.getElementById("queueInfo").innerHTML =
    `<b>${data.message}</b>`;
  showNotification("It's your turn! Please proceed to counter.");
  return;
}

      // show queue info
      document.getElementById("queueInfo").innerHTML =
  `Token #${data.token_number}<br>
   Estimated wait: ${data.estimated_wait} minutes`;


      // notification on status change
      if (lastStatus && lastStatus !== data.status) {
        showNotification(
        data.status === "SERVED"
        ? "Your token is now served!"
        : data.status === "YOUR_TURN"
          ? "It's your turn now!"
          : "Token status updated"
        );
      }
      lastStatus = data.status;  // ‚úÖ save current status

    });
}

function showNotification(msg) {
  const box = document.getElementById("notification");
  box.innerText = msg;
  box.style.display = "block";

  setTimeout(() => {
    box.style.display = "none";
  }, 4000);
}

// poll every 3 seconds
setInterval(checkTokenStatus, 3000);
checkTokenStatus();
</script>
<script>
function openAccount() {
  document.querySelector(".sidebar").style.display = "none";
  document.querySelector(".content").style.marginLeft = "0";

  document.querySelectorAll(".page")
    .forEach(p => p.classList.remove("active"));

  document.getElementById("accountPage").classList.add("active");

  loadAccount();
}
</script>

<script>
function loadAccount() {
  fetch("/user/account")
    .then(res => {
      if (res.status === 403) {
        showToast("Unauthorized access", true);
        return null;
      }
      return res.json();
    })
    .then(data => {
      if (!data) return;

      document.getElementById("accName").innerText = data.name;
      document.getElementById("accEmail").innerText = data.email;
      document.getElementById("accTokenCount").innerText = data.total_tokens;

      const list = document.getElementById("tokenHistory");
      list.innerHTML = "";

      data.history.forEach(t => {
        const div = document.createElement("div");
        div.className = "history-card";
        div.innerHTML = `
          <b>${t.queue}</b><br>
          Token #${t.token} ‚Ä¢ <span>${t.status}</span>
        `;
        list.appendChild(div);
      });
    });
}

</script>
<script>
function changePassword() {
  const current = document.getElementById("currentPwd").value;
  const newPwd = document.getElementById("newPwd").value;

  fetch("/user/change_password", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ current, new: newPwd })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) showToast(data.error, true);
    else showToast(data.message);
  });
}
</script>
<script>
function showAccountSection(section) {
  document.querySelectorAll(".account-section")
    .forEach(s => s.classList.remove("active"));

  document.querySelectorAll(".account-tab")
    .forEach(b => b.classList.remove("active"));

  if (section === "basic") {
    document.getElementById("basicSection").classList.add("active");
    document.querySelectorAll(".account-tab")[0].classList.add("active");
  }

  if (section === "history") {
    document.getElementById("historySection").classList.add("active");
    document.querySelectorAll(".account-tab")[1].classList.add("active");
  }

  if (section === "password") {
    document.getElementById("passwordSection").classList.add("active");
    document.querySelectorAll(".account-tab")[2].classList.add("active");
  }
}
</script>

<script>
function logoutUser() {
  fetch("/logout")
    .then(() => {
      window.location.href = "/login";
    });
}
</script>
<script>
function goHome() {
  document.querySelector(".sidebar").style.display = "block";
  document.querySelector(".content").style.marginLeft = "30px";

  document.querySelectorAll(".page")
    .forEach(p => p.classList.remove("active"));

  document.getElementById("getToken").classList.add("active");
}
</script>


</body>
</html>

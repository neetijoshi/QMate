<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>QMate User Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* =========================
   ROOT VARIABLES
========================= */
:root {
  --primary: #4d69a5;
  --accent: #ecd386;
  --bg: #f4f6fb;
  --dark: #2c2c2c;
  --text: #323232;
}

/* =========================
   GLOBAL
========================= */
html, body {
  height: 100%;
  margin: 0;
}

body {
  display: flex;
  flex-direction: column;
  font-family: "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--dark);
}

/* =========================
   NAVBAR
========================= */
.navbar {
  background: #fff;
  padding: 15px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #ddd;
  flex-shrink: 0;
}

.navbar h2 {
  margin: 0;
  color: var(--primary);
  font-weight: 600;
}

.user-type {
  display: flex;
  gap: 10px;
}

.user-type button {
  border: 1px solid var(--primary);
  padding: 6px 14px;
  border-radius: 20px;
  background: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.user-type button:hover {
  background: #f3f3f3;
}

.user-type button.active {
  background: var(--primary);
  color: white;
}

/* =========================
   MAIN LAYOUT
========================= */
.container {
  flex: 1;                 /* pushes footer down */
  display: flex;
  gap: 30px;
  padding: 30px;
  align-items: flex-start;
}

/* =========================
   SIDEBAR
========================= */
.sidebar {
  width: 260px;
  background: white;
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.sidebar button {
  width: 100%;
  background: none;
  border: none;
  cursor: pointer;
  text-align: left;
  padding: 12px 10px;
  border-radius: 8px;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text);
  transition: 0.2s;
}

.sidebar button:hover {
  background: #f3f3f3;
}

.sidebar button.active {
  background: var(--primary);
  color: white;
}

/* Logout button */
.sidebar button.logout-btn {
  background: var(--accent);
  color: var(--text);
  font-weight: 600;
  margin-top: 20px;
  justify-content: center;
}

.sidebar button.logout-btn:hover {
  filter: brightness(0.95);
}

/* =========================
   CONTENT AREA
========================= */
.content {
  flex: 1;
}

/* =========================
   PAGE CARDS
========================= */
.page {
  background: white;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  display: none;
  animation: fadeUp 0.4s ease;
}

.page.active {
  display: block;
}

.page h3 {
  margin-top: 0;
  color: var(--primary);
}

.page h4 {
  margin-bottom: 8px;
  color: #666;
}

/* =========================
   BUTTONS
========================= */
.main-btn {
  width: 100%;
  border: none;
  border-radius: 25px;
  padding: 14px 24px;
  font-size: 15px;
  background: var(--accent);
  color: var(--text);
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  transition: 0.2s;
}

.main-btn:hover {
  filter: brightness(0.95);
}

.main-btn[disabled] {
  cursor: not-allowed;
  opacity: 0.75;
}

/* Small button */
.small-btn {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  background: var(--accent);
  font-weight: 600;
  cursor: pointer;
  width: auto;
}

/* =========================
   ACCOUNT SECTION
========================= */
.account-tab {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 8px;
  border: none;
  background: #f3f3f3;
  border-radius: 6px;
  cursor: pointer;
  text-align: left;
  font-weight: 500;
}

.account-tab.active {
  background: var(--primary);
  color: white;
}

.account-section {
  display: none;
}

.account-section.active {
  display: block;
}

/* =========================
   HISTORY
========================= */
.history-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 15px;
}

.history-card {
  padding: 14px 18px;
  background: #f8f8f8;
  border-left: 6px solid var(--primary);
  border-radius: 8px;
  font-size: 14px;
}

/* =========================
   INPUTS
========================= */
input[type="password"] {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 6px;
  font-size: 14px;
}

input[type="password"]:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(77,105,165,0.2);
}

/* =========================
   FOOTER
========================= */
footer {
  background: #1f1f1f;
  color: #ccc;
  text-align: center;
  padding: 30px 20px;
  flex-shrink: 0;
}

footer p {
  margin: 0;
  font-size: 14px;
}

footer a {
  color: #ccc;
  text-decoration: none;
}

footer a:hover {
  color: var(--accent);
}

/* =========================
   ANIMATIONS
========================= */
@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
html, body {
  height: 100%;
}

body {
  margin: 0;
}

#progressBar {
  height: 12px;
  width: 0%;
  background: #4d69a5;
  border-radius: 10px;
  transition: width 0.5s ease;
}
.app-wrapper { min-height: calc(100vh - 80px); /* navbar + footer space */ }

</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

</head>

<body>
<div class="app-wrapper">
<!-- NAVBAR -->
<div class="navbar">
  <h2 style="color: var(--primary); margin: 0;">QMate</h2>

  <div style="display:flex; align-items:center; gap:15px;">
    <div class="user-type">
      <button class="active">User</button>
      <button onclick="window.location.href='/login'">Admin</button>
    </div>

    <!-- PROFILE ICON -->
    <div onclick="openAccount()" style="
      cursor:pointer;
      background:#4d69a5;
      color:white;
      width:36px;
      height:36px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
    ">
      <i class="fa-solid fa-user"></i>
    </div>
    <div onclick="goHome()" style="
  cursor:pointer;
  background:#f3f3f3;
  color:#4d69a5;
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
">
  <i class="fa-solid fa-house"></i>
</div>

  </div>
</div>


<!-- MAIN LAYOUT -->
<div class="container">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <button class="active" onclick="switchPage('getToken', this)"><i class="fa-solid fa-ticket"></i> Get Token</button>
    <button onclick="switchPage('queueStatusPage', this)"><i class="fa-solid fa-bars-progress"></i> Queue Status</button>
    <button onclick="openNotifications(this)" style="position:relative;">
  <i class="fa-solid fa-bell"></i> Notifications

  <!-- üî¥ notification dot -->
  <span id="notifDot" style="
    position:absolute;
    top:10px;
    left:26px;
    width:8px;
    height:8px;
    background:#e53935;
    border-radius:50%;
    display:none;
  "></span>
</button>

    <button class="logout-btn" onclick="logoutUser()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    <div style="
  margin-top:40px;
  font-size:12px;
  color:#999;
  text-align:center;
">
  ¬© 2026 QMate.
</div>

  </div>
<!-- CONTENT AREA -->
<div class="content">
  <div style="
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:30px;
">
  <div class="page" style="text-align:center;">
    <h4>Total Tokens</h4>
    <h2 style="color:var(--primary);">12</h2>
  </div>

  <div class="page">
    <h4>Current Queue</h4>
    <h2 style="color:var(--primary);">Billing</h2>
  </div>

  <div class="page">
    <h4>Estimated Wait</h4>
    <h2 style="color:var(--primary);">15 min</h2>
  </div>
</div>

  <!-- Get Token Page -->
  <div class="page active" id="getToken">
    <h3>Get Queue Token</h3>
    <p>Select a service queue to join and get your token number.</p>

    <label>Available Queues</label><br><br>
    <select id="queueSelect" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:6px;">
      <option value="">Select a queue to join</option>
      <option>Billing</option>
      <option>General Helpdesk</option>
      <option>Document Verification</option>
    </select><br><br>

    {% if guest %}
      <button class="main-btn" disabled>Login to get tokens.</button>
      <div class="small-note">
        Please <a href="{{ url_for('main.index') }}">login or register</a> to get a token.
      </div>
    {% else %}
      <button id="getTokenBtn" class="main-btn" onclick="requestToken()">Get My Token</button>
    {% endif %}
    <label>
  <input type="checkbox" id="scheduleCheck"> Schedule token
</label><br><br>
<input
  type="text"
  id="scheduleTime"
  placeholder="Select date & time"
  style="
    display:none;
    width:100%;
    padding:12px 14px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:14px;
    margin-top:10px;
  "
/>


  </div>

<!-- Queue Status Page -->
<div class="page" id="queueStatusPage">
  <h3>Current Queue Status</h3>

  <p id="queuePlaceholder" style="
    color:#666;
    background:#f4f6fb;
    padding:16px;
    border-radius:10px;
  ">
    You haven‚Äôt taken a token yet.<br>
    <b>Get a token to view live queue progress.</b>
  </p>

  <p id="queueInfo"></p>

  <!-- ACTION BUTTONS -->
    <div id="queueActions" style="
  margin-top:20px;
  gap:12px;
  display:none;
  flex-wrap:wrap;
">
    <button class="small-btn" onclick="pauseToken()">I'm Late</button>
    <button class="small-btn"
            style="background:#e57373; color:white;"
            onclick="cancelToken()">Cancel Token</button>
  </div>

  <!-- PROGRESS BAR -->
  <div id="progressSection" style="display:none; margin-top:20px;">
    <div style="background:#eee; border-radius:10px; height:12px;">
      <div id="progressBar"></div>
    </div>
    <small id="progressText">Waiting...</small>
  </div>
</div>


  <!-- Notifications Page -->
  <div class="page" id="notifications">
    <h3>Notifications</h3>
    <p>Your updates and alerts will appear here.</p>
    <div id="nowServing"
     style="padding:10px;font-weight:600;color:#4d69a5;">
</div>

  </div>

  <!-- ‚úÖ ACCOUNT PAGE (NOW REALLY INSIDE CONTENT) -->
  <div class="page" id="accountPage" style="max-width:900px; margin:40px auto;">
    <h3>My Account</h3>

    <div style="display:flex; gap:30px; margin-top:20px;">

      <!-- ACCOUNT SIDE MENU -->
      <div style="width:220px;">
        <button class="account-tab active" onclick="showAccountSection('basic')">
          Basic Info
        </button>
        <button class="account-tab" onclick="showAccountSection('history')">
          Token History
        </button>
        <button class="account-tab" onclick="showAccountSection('password')">
          Change Password
        </button>
      </div>

      <!-- ACCOUNT CONTENT -->
      <div style="flex:1;">

        <!-- BASIC INFO -->
        <div id="basicSection" class="account-section active">
          <p><b>Name:</b> <span id="accName"></span></p>
          <p><b>Email:</b> <span id="accEmail"></span></p>
          <p><b>Total Tokens Taken:</b> <span id="accTokenCount"></span></p>
        </div>

        <!-- TOKEN HISTORY -->
        <div id="historySection" class="account-section">
          <h4>Token History</h4>
          <div id="tokenHistory" class="history-list"></div>
        </div>

        <!-- CHANGE PASSWORD -->
        <div id="passwordSection" class="account-section">
          <label>Current Password</label><br>
          <input type="password" id="currentPwd"><br><br>

          <label>New Password</label><br>
          <input type="password" id="newPwd"><br><br>

          <button class="small-btn" onclick="changePassword()">
            Update Password
          </button>
        </div>

      </div>
    </div>
  </div>

</div> <!-- ‚úÖ ONLY ONE closing for .content -->
<!-- SAME UI AS YOURS ABOVE -->
<!-- ONLY JS CHANGED -->
</div>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</body>
<script>
  flatpickr("#scheduleTime", {
  enableTime: true,
  dateFormat: "Y-m-d H:i",
  minDate: "today",
  time_24hr: false,
  minuteIncrement: 5,
  theme: "material_blue"
});

/* =========================
   PAGE SWITCHING
========================= */
function switchPage(pageId, btn) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(pageId)?.classList.add("active");

  document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
  btn?.classList.add("active");
}

/* =========================
   TOAST NOTIFICATIONS
========================= */
function showToast(msg, error = false) {
  const toast = document.createElement("div");
  toast.innerText = msg;
  toast.style.position = "fixed";
  toast.style.bottom = "30px";
  toast.style.right = "30px";
  toast.style.background = error ? "#c0392b" : "#4d69a5";
  toast.style.color = "white";
  toast.style.padding = "14px 20px";
  toast.style.borderRadius = "8px";
  toast.style.fontWeight = "500";
  toast.style.zIndex = "9999";

  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

/* =========================
   REQUEST TOKEN
========================= */
function requestToken() {
  const queue = document.getElementById("queueSelect")?.value;
  const scheduled = document.getElementById("scheduleCheck").checked
    ? document.getElementById("scheduleTime").value
    : null;

  if (!queue) {
    showToast("Select a queue first", true);
    return;
  }

  fetch("/request_token", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      queue: queue,
      scheduled_time: scheduled
    })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast(data.error, true);
      } else {
        if (scheduled) {
          showToast("Token scheduled successfully");
        } else {
          showToast("Your token number is " + data.token);
        }
      }
    })
    .catch(() => showToast("Server error", true));
}

/* =========================
   TOKEN STATUS POLLING
========================= */
let lastStatus = null;

function checkTokenStatus() {
  fetch("/user/token_status")
    .then(res => res.json())
    .then(data => {
      const placeholder = document.getElementById("queuePlaceholder");
      const info = document.getElementById("queueInfo");
      const progressSection = document.getElementById("progressSection");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const actions = document.getElementById("queueActions");

      if (!placeholder || !info) return;

      /* ‚ùå NO TOKEN */
      if (!data.has_token) {
        placeholder.style.display = "block";
        info.innerHTML = "";
        if (actions) actions.style.display = "none";
        if (progressSection) progressSection.style.display = "none";
        return;
      }

      /* ‚úÖ TOKEN EXISTS */
      placeholder.style.display = "none";
      if (progressSection) progressSection.style.display = "block";
      if (actions) actions.style.display = "flex";
      /* üïí SCHEDULED */
      if (data.status === "SCHEDULED") {
        info.innerHTML = `
          <div style="
            background:#e8eefc;
            padding:18px;
            border-radius:12px;
            font-weight:600;
          ">
            Token #${data.token_number}<br>
            Scheduled at <b>${data.scheduled_time}</b>
          </div>
        `;
        if (actions) actions.style.display = "none";
        progressBar.style.width = "40%";
        progressText.innerText = "Scheduled";
        return;
      }

      /* üéâ YOUR TURN */
      if (data.status === "YOUR_TURN") {
        info.innerHTML = `
          <div style="
            background:#ecd386;
            padding:18px;
            border-radius:12px;
            font-weight:600;
          ">
            It's your turn!<br>
            Please proceed to <b>${data.counter}</b>
          </div>
        `;
        if (actions) actions.style.display = "flex";
        progressBar.style.width = "100%";
        progressText.innerText = "Now serving";
        return;
      }

      /* ‚è≥ WAITING */
      info.innerHTML = `
        <b>Token #${data.token_number}</b><br>
        Status: Waiting
      `;

      if (actions) actions.style.display = "flex";

      if (data.estimated_wait !== null) {
        const percent = Math.max(10, Math.min(90, 100 - data.estimated_wait * 3));
        progressBar.style.width = percent + "%";
        progressText.innerText = `Estimated wait: ${data.estimated_wait} minutes`;
      } else {
        progressBar.style.width = "20%";
        progressText.innerText = "Waiting...";
      }
    })
    .catch(err => console.error("Token status error:", err));
}

setInterval(checkTokenStatus, 3000);
checkTokenStatus();

/* =========================
   ACCOUNT PAGE
========================= */
function openAccount() {
  document.querySelector(".sidebar")?.style.setProperty("display", "none");
  document.querySelector(".content")?.style.setProperty("marginLeft", "0");

  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById("accountPage")?.classList.add("active");

  loadAccount();
}

function loadAccount() {
  fetch("/user/account")
    .then(res => {
      if (res.status === 403) {
        showToast("Unauthorized access", true);
        return null;
      }
      return res.json();
    })
    .then(data => {
      if (!data) return;

      document.getElementById("accName").innerText = data.name;
      document.getElementById("accEmail").innerText = data.email;
      document.getElementById("accTokenCount").innerText = data.total_tokens;

      const list = document.getElementById("tokenHistory");
      list.innerHTML = "";

      data.history.forEach(t => {
        const div = document.createElement("div");
        div.className = "history-card";
        div.innerHTML = `<b>${t.queue}</b><br>Token #${t.token} ‚Ä¢ ${t.status}`;
        list.appendChild(div);
      });
    });
}

function showAccountSection(section) {
  document.querySelectorAll(".account-section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".account-tab").forEach(b => b.classList.remove("active"));

  document.getElementById(section + "Section")?.classList.add("active");

  const map = { basic: 0, history: 1, password: 2 };
  document.querySelectorAll(".account-tab")[map[section]]?.classList.add("active");
}

/* =========================
   PASSWORD CHANGE
========================= */
function changePassword() {
  const current = document.getElementById("currentPwd").value;
  const newPwd = document.getElementById("newPwd").value;

  if (!current || !newPwd) {
    showToast("Fill all fields", true);
    return;
  }

  fetch("/user/change_password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ current, new: newPwd })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) showToast(data.error, true);
      else showToast(data.message);
    });
}

/* =========================
   LOGOUT & HOME
========================= */
function logoutUser() {
  fetch("/logout").then(() => {
    window.location.href = "/logout";
  });
}

function goHome() {
  document.querySelector(".sidebar")?.style.setProperty("display", "block");
  document.querySelector(".content")?.style.setProperty("marginLeft", "30px");

  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById("getToken")?.classList.add("active");
}
function cancelToken() {
  fetch("/user/cancel_token", { method: "POST" })
    .then(res => res.json())
    .then(data => {
      showToast(data.message || "Token cancelled");

      // üî• FULL UI RESET
      document.getElementById("queuePlaceholder").style.display = "block";
      document.getElementById("queueInfo").innerHTML = "";
      document.getElementById("progressSection").style.display = "none";
      document.getElementById("queueActions").style.display = "none";
      document.getElementById("progressBar").style.width = "0%";
      document.getElementById("progressText").innerText = "Waiting...";
    });
}

function pauseToken() {
  fetch("/user/pause_token", { method: "POST" })
    .then(res => res.json())
    .then(data => {
      showToast(data.message || "Token paused");
      checkTokenStatus();
    });
}
document.getElementById("scheduleCheck").onchange = e => {
  document.getElementById("scheduleTime").style.display =
    e.target.checked ? "block" : "none";
};

let lastServedToken = null;

function checkNowServing() {
  fetch("/public/now_serving")
    .then(res => res.json())
    .then(data => {
      if (!data || !data.token_number) return;

      document.getElementById("nowServing").innerText =
        `Now Serving: ${data.queue} ‚Äì Token ${data.token_number}`;

      // üîî show dot ONLY if token changed
      if (data.token_number !== lastServedToken) {
        const dot = document.getElementById("notifDot");
        if (dot) dot.style.display = "block";
        lastServedToken = data.token_number;
      }
    });
}


setInterval(checkNowServing, 5000);

function openNotifications(btn) {
  // switch page like before
  switchPage('notifications', btn);

  // hide the dot when user opens notifications
  const dot = document.getElementById("notifDot");
  if (dot) dot.style.display = "none";
}

</script>

</html>
